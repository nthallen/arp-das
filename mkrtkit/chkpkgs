#! /bin/sh
function nl_error {
  echo "chkpkgs: $*" >&2
  exit 1
}

OK=yes

args=''

if [ x"$1" != x ]; then
  for i in $*; do
    args="$args pkgs/$i/Header"
  done
else
  args=`find pkgs -name Header`
fi
for hdr in $args; do
  pkg=${hdr%/Header}
  echo "Checking $pkg"
  while read fline; do
    if expr "$fline" : "Files:" >/dev/null; then
      fline=${fline#Files: }
      manif=${fline% @*}
      root=${fline#*@ }
      case $root in
	*/) ;;
	*) root="$root/";;
      esac
      if [ ! $manif = MANIFEST_pkg ]; then
	[ -f $pkg/$manif ] || nl_error "Cannot locate $pkg/$manif"
	while read fspec; do
	  if [ ! -d $root$fspec -a ! -f $root$fspec -a ! -h $root$fspec ]; then
	    echo "$pkg/$manif: File not found: $root$fspec"
	    OK=no
	  fi
	done < $pkg/$manif
      fi
    fi
  done <$hdr
done
[ "$OK" = "yes" ] || nl_error "Errors seen"
